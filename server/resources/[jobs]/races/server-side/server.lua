-----------------------------------------------------------------------------------------------------------------------------------------
-- VRP
-----------------------------------------------------------------------------------------------------------------------------------------
local Tunnel = module("vrp","lib/Tunnel")
local Proxy = module("vrp","lib/Proxy")
vRPC = Tunnel.getInterface("vRP")
vRP = Proxy.getInterface("vRP")
-----------------------------------------------------------------------------------------------------------------------------------------
-- CONNECTION
-----------------------------------------------------------------------------------------------------------------------------------------
cRP = {}
Tunnel.bindInterface("races",cRP)
vCLIENT = Tunnel.getInterface("races")
-----------------------------------------------------------------------------------------------------------------------------------------
-- VARIABLES
-----------------------------------------------------------------------------------------------------------------------------------------
local raceIlegal = {}
local raceCooldown = {}
-----------------------------------------------------------------------------------------------------------------------------------------
-- RACECIRCUITS
-----------------------------------------------------------------------------------------------------------------------------------------
local raceCircuits = {
	[1] = {
		["laps"] = 1,
		["explode"] = 225,
		["init"] = { -323.72,-1098.52,22.5 },
		["coords"] = {
			{ -224.22,-1141.04,22.44 },
			{ -52.27,-1004.82,28.46 },
			{ 158.21,-1024.68,28.76 },
			{ 274.84,-909.99,28.37 },
			{ 586.74,-856.58,40.57 },
			{ 1046.5,-846.35,48.06 },
			{ 1169.86,-259.31,68.49 },
			{ 753.01,-19.7,81.49 },
			{ 536.97,-100.18,64.33 },
			{ 75.1,-6.83,68.06 },
			{ 9.84,-88.45,58.1 },
			{ 40.49,-152.91,54.81 },
			{ -92.1,-608.92,35.69 },
			{ -15.89,-686.8,31.69 },
			{ 53.95,-626.46,31.0 },
			{ 243.05,-620.26,27.95 },
			{ 445.56,-677.4,27.94 },
			{ 500.54,-1090.2,28.43 },
			{ 380.5,-1154.29,28.68 },
			{ 267.53,-1184.87,37.61 },
			{ -276.55,-1186.02,36.61 },
			{ -380.67,-693.41,36.68 },
			{ 199.31,-524.46,33.43 },
			{ 846.6,-717.63,41.87 },
			{ 975.2,-841.31,45.24 },
			{ 913.03,-909.42,32.35 },
			{ 857.78,-883.29,24.84 }
		}
	},
	[2] = {
		["laps"] = 1,
		["explode"] = 175,
		["init"] = { 705.7,-1572.68,9.2 },
		["coords"] = {
			{ 653.25,-1401.34,9.08 },
			{ 617.07,-1221.83,9.23 },
			{ 768.9,-1176.81,26.81 },
			{ 828.12,-1671.09,28.71 },
			{ 1106.81,-1742.12,35.08 },
			{ 1250.1,-1604.4,52.44 },
			{ 1408.07,-1517.74,58.42 },
			{ 1382.41,-1571.53,54.04 },
			{ 1275.46,-1475.31,35.97 },
			{ 749.46,-1431.13,28.63 },
			{ 277.26,-1297.43,28.98 },
			{ 218.77,-1111.33,28.7 },
			{ 151.97,-1013.31,28.75 },
			{ 195.72,-778.02,31.53 },
			{ 117.9,-704.49,32.49 },
			{ 96.98,-622.23,31.0 },
			{ -6.52,-546.83,37.78 },
			{ 54.23,-216.09,51.7 },
			{ 18.41,-67.52,61.54 },
			{ 66.06,119.29,78.5 }
		}
	},
	[3] = {
		["laps"] = 1,
		["explode"] = 225,
		["init"] = { -2179.81,-386.2,12.8 },
		["coords"] = {
			{ -2269.27,-326.95,12.84 },
			{ -3021.75,175.75,15.2 },
			{ -3075.81,342.37,6.59 },
			{ -3069.24,676.37,12.5 },
			{ -3005.93,613.59,19.58 },
			{ -2688.47,-49.1,15.3 },
			{ -2237.01,-344.87,12.84 },
			{ -1889.77,-216.14,36.48 },
			{ -1644.21,-340.37,49.49 },
			{ -1504.52,-400.02,38.92 },
			{ -1176.59,-298.85,36.99 },
			{ -882.56,-593.02,29.44 },
			{ -586.62,-664.77,31.9 },
			{ -351.01,-732.38,33.33 },
			{ -245.73,-879.86,29.98 },
			{ -258.05,-1061.09,25.53 },
			{ -26.9,-1143.33,26.23 },
			{ 84.61,-1071.81,28.73 },
			{ 32.58,-965.06,28.75 },
			{ -109.59,-1300.74,28.68 },
			{ -475.17,-1407.95,28.73 },
			{ -501.19,-1159.25,19.19 },
			{ -576.07,-1149.71,21.55 }
		}
	},
	[4] = {
		["laps"] = 1,
		["explode"] = 225,
		["init"] = { -355.02,-92.2,45.1 },
		["coords"] = {
			{ -445.52,-92.76,39.45 },
			{ -746.34,-246.8,36.45 },
			{ -815.89,-349.05,36.56 },
			{ -1100.38,-503.14,35.03 },
			{ -1433.1,-726.25,22.85 },
			{ -1667.9,-564.79,33.3 },
			{ -1941.07,-430.95,18.57 },
			{ -1972.4,-482.63,11.07 },
			{ -1424.09,-773.24,10.48 },
			{ -657.42,-537.82,24.57 },
			{ -428.83,-846.73,38.25 },
			{ -404.37,-1391.73,27.94 },
			{ -276.79,-1438.02,30.72 },
			{ -71.81,-1581.52,29.86 },
			{ 219.09,-1106.55,28.7 },
			{ 334.99,-744.52,28.7 },
			{ 250.08,-623.63,27.99 },
			{ 63.42,-657.75,30.97 },
			{ -85.06,-1067.84,26.56 },
			{ -251.1,-1067.86,25.26 },
			{ -316.56,-1007.78,29.76 }
		}
	},
	[5] = {
		["laps"] = 1,
		["explode"] = 175,
		["init"] = { 844.03,-1986.06,28.7 },
		["coords"] = {
			{ 818.72,-1885.56,28.68 },
			{ 508.3,-1661.18,28.68 },
			{ 83.68,-1313.1,28.7 },
			{ 61.28,-1061.77,28.76 },
			{ 18.14,-1078.48,37.52 },
			{ 50.92,-1262.84,28.68 },
			{ 88.82,-1471.55,28.73 },
			{ 233.2,-1636.74,28.665 },
			{ 208.57,-1740.39,28.36 },
			{ 86.25,-1872.65,23.08 },
			{ -70.54,-1792.65,27.36 },
			{ -7.89,-1704.06,28.68 },
			{ 238.2,-1842.5,25.95 },
			{ 288.99,-2010.61,19.46 },
			{ 328.59,-2164.98,13.68 },
			{ 326.63,-2466.15,5.32 },
			{ 113.41,-2551.67,5.36 },
			{ -99.83,-2440.29,5.37 },
			{ -203.31,-2669.89,5.37 }
		}
	},
	[6] = {
		["laps"] = 1,
		["explode"] = 175,
		["init"] = { -556.95,-2126.83,5.4 },
		["coords"] = {
			{ -566.13,-2066.1,6.2 },
			{ -289.64,-2137.76,20.47 },
			{ 83.73,-2046.85,17.73 },
			{ 272.64,-1882.56,26.22 },
			{ 435.46,-1687.14,28.66 },
			{ 224.21,-1426.76,28.7 },
			{ 226.57,-1187.92,28.63 },
			{ 109.76,-1129.5,28.68 },
			{ 34.53,-966.01,28.76 },
			{ 30.45,-771.0,43.61 },
			{ -163.59,-697.3,36.45 },
			{ -305.48,-627.21,32.77 },
			{ -147.28,-702.32,38.45 },
			{ 22.86,-772.25,43.57 },
			{ 213.43,-840.83,29.91 },
			{ 233.99,-985.25,28.66 },
			{ 337.86,-1057.16,28.7 },
			{ 344.62,-1131.74,28.78 },
			{ 207.86,-1290.27,28.7 },
			{ 9.93,-1553.64,28.68 },
			{ -224.12,-1800.19,29.12 },
			{ -385.08,-1871.72,19.9 }
		}
	},
	[7] = {
		["laps"] = 1,
		["explode"] = 175,
		["init"] = { 640.87,654.66,128.3 },
		["coords"] = {
			{ 869.41,532.96,124.86 },
			{ 605.69,304.87,105.36 },
			{ 314.81,325.32,104.89 },
			{ 135.76,13.65,68.16 },
			{ -480.81,129.31,63.3 },
			{ -592.47,-97.27,41.72 },
			{ -622.78,-162.42,37.25 },
			{ -656.78,-316.83,34.49 },
			{ -328.85,-402.5,29.44 },
			{ -236.34,-594.05,33.65 },
			{ -271.0,-811.96,31.31 },
			{ 59.94,-988.78,28.8 },
			{ 183.17,-1420.57,28.68 },
			{ 102.51,-1633.5,28.71 },
			{ 417.01,-1999.71,22.46 },
			{ 680.99,-2064.71,28.66 },
			{ 727.96,-2125.79,28.63 }
		}
	},
	[8] = {
		["laps"] = 5,
		["explode"] = 175,
		["init"] = { -128.62,-2121.85,16.1 },
		["coords"] = {
			{ -114.22,-2011.78,17.39,348.67 },
			{ -74.76,-1989.74,17.39,266.46 },
			{ -63.65,-2010.36,17.39,291.97 },
			{ -70.61,-2101.47,16.07,291.97 },
			{ -43.5,-2103.99,16.07,110.56 },
			{ -134.91,-2137.18,16.07,96.38 }
		}
	},
	[9] = {
		["laps"] = 2,
		["explode"] = 225,
		["init"] = { 1573.88,3215.53,39.78 },
		["coords"] = {
			{ 1784.01,3354.35,39.92 },
			{ 1578.62,3710.06,33.88 },
			{ 1694.01,3887.1,34.26 },
			{ 2029.23,3779.86,31.68 },
			{ 2155.5,3486.88,44.74 },
			{ 2225.48,3323.61,45.09 },
			{ 2425.27,3205.3,48.19 },
			{ 2655.63,3394.05,55.22 },
			{ 2741.4,3314.33,55.4 },
			{ 2405.87,2974.54,47.01 },
			{ 2033.15,3085.96,46.3 }
		}
	},
	[10] = {
		["laps"] = 1,
		["explode"] = 225,
		["init"] = { 2689.72,1376.34,23.9 },
		["coords"] = {
			{ 2689.56,1578.66,23.94 },
			{ 2590.42,1642.04,27.6 },
			{ 2540.0,2025.1,19.36 },
			{ 2486.44,2806.77,47.1 },
			{ 2682.65,3161.06,51.44 },
			{ 2843.69,4299.88,49.59 },
			{ 2982.98,4554.76,50.72 },
			{ 2898.66,4825.43,61.81 },
			{ 2760.15,5101.15,62.24 },
			{ 2567.36,5598.45,61.05 },
			{ 2150.11,6104.17,60.29 },
			{ 1805.86,6290.72,49.29 },
			{ 1611.3,6388.77,26.79 },
			{ 837.2,6498.44,21.82 },
			{ -5.27,6377.03,30.65 },
			{ 15.29,6278.11,30.63 }
		}
	},
	[11] = {
		["laps"] = 1,
		["explode"] = 255,
		["init"] = { -409.34,1219.39,325.02 },
		["coords"] = {
			{ -456.61,1195.11,325.07 },
			{ -380.32,1447.47,288.27 },
			{ -22.5,1459.4,275.48 },
			{ 183.97,1360.57,244.69 },
			{ 314.05,949.22,207.37 },
			{ 271.88,601.01,152.39 },
			{ 126.28,404.4,115.83 },
			{ -40.11,56.43,71.75 },
			{ -29.12,-128.43,56.48 },
			{ 281.89,-248.46,53.41 },
			{ 274.44,-527.18,42.63 },
			{ 135.29,-896.98,29.69 },
			{ 484.9,-1044.75,34.32 },
			{ 792.12,-1331.77,25.65 },
			{ 806.3,-1811.27,28.71 },
			{ 724.77,-2708.78,6.55 },
			{ 717.39,-3089.63,14.73 },
			{ 960.72,-3326.21,5.8 },
			{ 1210.82,-3341.68,5.17 },
			{ 1257.67,-3164.18,5.16 },
			{ 1115.64,-3114.88,5.17 },
			{ 741.99,-2928.17,5.19 },
			{ 627.38,-2660.26,5.46 },
			{ 514.19,-2443.47,14.34 },
			{ 273.22,-2503.74,5.81 }
		}
	},
	[12] = {
		["laps"] = 1,
		["explode"] = 275,
		["init"] = { 132.11,-2815.55,5.37 },
		["coords"] = {
			{ 115.18,-2885.2,5.36 },
			{ 111.91,-3042.17,5.37 },
			{ 138.82,-3092.76,5.26 },
			{ 192.82,-2857.71,9.17 },
			{ 418.21,-2688.85,23.64 },
			{ 1110.19,-2577.03,31.14 },
			{ 1316.7,-2590.0,46.84 },
			{ 1641.17,-2452.99,86.22 },
			{ 1816.03,-1465.46,119.3 },
			{ 1988.14,-1011.61,85.88 },
			{ 1902.9,-971.8,78.52 },
			{ 1521.95,-1465.19,71.34 },
			{ 1387.15,-1528.33,56.36 },
			{ 1122.48,-1431.12,34.88 },
			{ 858.47,-1432.08,28.17 },
			{ 804.26,-1277.35,25.78 },
			{ 792.2,-1059.75,26.82 },
			{ 466.77,-1036.37,32.89 },
			{ 174.73,-1019.65,28.71 },
			{ -22.72,-1132.85,26.37 },
			{ -180.63,-1399.55,30.26 },
			{ -87.32,-1569.28,31.32 },
			{ -101.3,-1685.43,28.7 },
			{ 21.87,-1871.44,22.58 },
			{ 129.51,-1821.62,26.39 },
			{ 325.38,-1915.25,24.72 },
			{ 499.01,-1742.37,28.26 },
			{ 566.04,-1552.35,28.63 },
			{ 269.77,-1296.58,28.7 },
			{ 256.91,-1155.78,28.64 }
		}
	},
	[13] = {
		["laps"] = 1,
		["explode"] = 225,
		["init"] = { 28.48,-600.76,31.02 },
		["coords"] = {
			{ 29.64,-656.78,31.0 },
			{ -106.61,-669.95,34.81 },
			{ -301.88,-658.25,32.55 },
			{ -284.54,-765.13,52.62 },
			{ -171.16,-850.91,29.32 },
			{ -96.77,-930.56,28.7 },
			{ -82.72,-1084.8,26.08 },
			{ 66.53,-1097.67,28.76 },
			{ -48.71,-987.09,28.68 },
			{ 170.5,-1025.1,28.75 },
			{ 343.68,-855.24,28.71 },
			{ 460.41,-825.04,26.71 },
			{ 500.75,-1097.41,28.53 },
			{ 379.65,-1154.94,28.66 },
			{ 106.32,-1188.3,36.82 },
			{ -349.72,-1201.02,40.66 },
			{ -453.67,-1353.75,32.72 },
			{ -162.43,-1400.75,29.94 },
			{ 202.96,-1342.27,28.7 },
			{ 661.1,-1441.88,30.19 },
			{ 792.37,-1613.77,30.57 }
		}
	},
	[14] = {
		["laps"] = 1,
		["explode"] = 175,
		["init"] = { 124.45,-2191.21,5.40 },
		["coords"] = {
			{ 197.46,-2190.05,6.45 },
			{ 233.7,-2107.04,16.21 },
			{ 439.03,-1856.18,27.09 },
			{ 561.54,-1661.49,27.65 },
			{ 592.0,-1797.58,22.01 },
			{ 444.57,-1931.97,23.98 },
			{ 239.58,-1816.58,26.49 },
			{ 98.48,-1697.65,28.53 },
			{ -86.94,-1727.11,28.7 },
			{ -183.98,-1637.51,32.81 },
			{ -97.26,-1501.38,32.94 },
			{ 26.73,-1475.74,29.55 },
			{ 229.43,-1264.95,28.68 },
			{ 169.19,-1019.27,28.73 },
			{ 159.7,-873.96,30.06 },
			{ 87.67,-786.25,30.94 },
			{ -9.2,-884.86,29.37 },
			{ -125.43,-915.96,28.68 },
			{ -81.99,-606.31,35.65 },
			{ 22.55,-378.19,38.77 }
		}
	},
	[15] = {
		["laps"] = 1,
		["explode"] = 200,
		["init"] = { -1309.01,-1331.07,4.08 },
		["coords"] = {
			{ -1266.51,-1358.99,3.57 },
			{ -1007.48,-1264.5,5.43 },
			{ -1018.93,-1098.14,1.43 },
			{ -1071.95,-899.15,3.54 },
			{ -897.0,-831.15,17.09 },
			{ -931.56,-477.49,36.34 },
			{ -819.87,-356.36,36.9 },
			{ -711.9,-359.26,33.99 },
			{ -511.01,-281.12,34.83 },
			{ -492.07,-175.8,37.1 },
			{ -401.01,-43.79,45.48 },
			{ -166.64,-87.11,52.91 },
			{ -13.67,110.06,80.74 },
			{ -62.79,288.27,104.6 },
			{ -49.21,396.19,112.57 },
			{ 45.58,291.22,109.62 },
			{ 133.5,213.45,106.52 },
			{ 121.8,-29.84,67.1 },
			{ 167.42,-206.94,53.58 },
			{ 230.21,-356.05,43.69 },
			{ 230.21,-637.35,39.21},
			{ 237.1,-844.21,29.35 },
			{ 233.69,-913.41,26.52 },
			{ 215.71,-991.84,28.49 },
			{ 331.31,-1000.47,28.64 }
		}
	},
	[16] = {
		["laps"] = 1,
		["explode"] = 300,
		["init"] = { -742.29,-68.62,41.20 },
		["coords"] = {
			{ -663.87,-58.87,38.38 },
			{ -481.2,-195.05,36.51 },
			{ -358.62,-278.03,32.65 },
			{ -239.45,-417.5,29.55 },
			{ -242.08,-608.69,33.43 },
			{ -139.97,-706.5,39.39 },
			{ 35.71,-777.27,43.59 },
			{ 120.82,-802.41,30.72 },
			{ 239.12,-660.9,37.88 },
			{ 416.22,-557.38,44.1 },
			{ 581.89,-411.46,42.95 },
			{ 698.39,-174.55,47.3 },
			{ 1050.64,302.09,85.9 },
			{ 1163.04,331.53,91.33 },
			{ 855.49,20.33,78.5 },
			{ 1138.61,-252.77,68.46 },
			{ 1271.65,-408.52,68.46 },
			{ 1276.29,-618.13,68.41 },
			{ 1092.36,-758.95,57.15 },
			{ 912.33,-593.59,56.77 },
			{ 1048.03,-418.69,65.83 },
			{ 1002.77,-311.43,66.56 },
			{ 719.64,-367.6,41.86 },
			{ 517.38,-367.43,42.98 },
			{ 563.48,-582.1,43.62 },
			{ 568.17,-782.37,10.58 },
			{ 573.42,-1290.54,9.07 },
			{ 654.69,-1678.36,9.03 },
			{ 597.26,-1975.21,19.01 },
			{ 522.31,-2038.39,26.56 },
			{ 210.7,-1792.31,28.11 },
			{ 93.51,-1864.35,23.67 },
			{ -130.0,-1735.66,29.47 },
			{ -157.05,-1570.08,34.36 },
			{ -240.68,-1417.93,30.55 },
			{ -251.36,-1306.65,30.65 },
			{ -183.71,-1292.14,30.67 }
		}
	}
}
-----------------------------------------------------------------------------------------------------------------------------------------
-- FINISHRACE
-----------------------------------------------------------------------------------------------------------------------------------------
function cRP.finishRace(raceId,racePoints,vehName)
	local source = source
	local user_id = vRP.getUserId(source)
	if user_id then
		if raceIlegal[user_id] ~= nil then
			vRP.generateItem(user_id,"dollarsz",math.random(775,975),true)
			TriggerEvent("blipsystem:serviceExit",source)
			raceIlegal[user_id] = nil
		end
	end
end
-----------------------------------------------------------------------------------------------------------------------------------------
-- CHECKTICKET
-----------------------------------------------------------------------------------------------------------------------------------------
function cRP.checkTicket(raceId)
	local source = source
	local user_id = vRP.getUserId(source)
	if user_id then
		if raceCooldown[raceId] == nil then
			raceCooldown[raceId] = {}
		end

		if raceCooldown[raceId][user_id] == nil then
			raceCooldown[raceId][user_id] = GetGameTimer()
		end

		if GetGameTimer() >= raceCooldown[raceId][user_id] then
			raceCooldown[raceId][user_id] = GetGameTimer() + (120 * 60000)

			if vRP.tryGetInventoryItem(user_id,"credential",1) then
				TriggerEvent("blipsystem:serviceEnter",source,"Corredor",48)
				raceIlegal[user_id] = true

				local policeResult = vRP.numPermission("Police")
				for k,v in pairs(policeResult) do
					async(function()
						TriggerClientEvent("Notify",v,"amarelo","Detectamos um corredor clandestino nas ruas.",2000)
						vRPC.playSound(v,"Beep_Red","DLC_HEIST_HACKING_SNAKE_SOUNDS")
					end)
				end
			end

			return true,raceIlegal[user_id]
		else
			TriggerClientEvent("Notify",source,"azul","Aguarde <b>"..parseInt((raceCooldown[raceId][user_id] - GetGameTimer()) / 1000).." segundos</b> para o mesmo circuito.",5000)
		end
	end

	return false
end
-----------------------------------------------------------------------------------------------------------------------------------------
-- EXITRACE
-----------------------------------------------------------------------------------------------------------------------------------------
function cRP.exitRace()
	local source = source
	local user_id = vRP.getUserId(source)
	if user_id then
		if raceIlegal[user_id] ~= nil then
			TriggerEvent("blipsystem:serviceExit",source)
			raceIlegal[user_id] = nil
		end
	end
end
-----------------------------------------------------------------------------------------------------------------------------------------
-- PLAYERLEAVE
-----------------------------------------------------------------------------------------------------------------------------------------
AddEventHandler("vRP:playerLeave",function(user_id,source)
	if raceIlegal[user_id] then
		raceIlegal[user_id] = nil
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- RACES:DEFUSEBOMB
-----------------------------------------------------------------------------------------------------------------------------------------
RegisterServerEvent("races:defuseBomb")
AddEventHandler("races:defuseBomb",function()
	local source = source
	local user_id = vRP.getUserId(source)
	if user_id then
		local otherPlayer = vRPC.nearestPlayer(source,10)
		if otherPlayer then
			if vRP.hasGroup(user_id,"Police") then
				TriggerClientEvent("races:defuseBombs",otherPlayer)
				TriggerClientEvent("racesTrevor:defuseBombs",otherPlayer)
			end
		end
	end
end)
-----------------------------------------------------------------------------------------------------------------------------------------
-- PLAYERSPAWN
-----------------------------------------------------------------------------------------------------------------------------------------
AddEventHandler("vRP:playerSpawn",function(user_id,source)
	vCLIENT.updateRaces(source,raceCircuits)
end)